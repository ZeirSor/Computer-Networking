# Chapter 5 Transport layer

<!-- TOC -->

- [1. 运输层概述](#1-运输层概述)
	- [1.1. 进程间基于网络的通信](#11-进程间基于网络的通信)
	- [1.2. TCP/IP运输层中的两个重要协议](#12-tcpip运输层中的两个重要协议)
	- [1.3. 运输层端口号](#13-运输层端口号)
	- [1.4. 发送方的复用和接收方的分用](#14-发送方的复用和接收方的分用)
		- [1.4.1. TCP/IP体系结构应用层常用协议所使用的运输层协议和熟知端口号](#141-tcpip体系结构应用层常用协议所使用的运输层协议和熟知端口号)
	- [1.5. 运输层端口号应用举例](#15-运输层端口号应用举例)
- [2. UDP和TCP的对比](#2-udp和tcp的对比)
	- [2.1. 无连接的UDP和面向连接的TCP](#21-无连接的udp和面向连接的tcp)
	- [2.2. 对单播、多播和广播的支持情况](#22-对单播多播和广播的支持情况)
	- [2.3. 对应用层报文的处理](#23-对应用层报文的处理)
	- [2.4. 对数据传输可靠性的支持情况](#24-对数据传输可靠性的支持情况)
	- [2.5. 首部对比](#25-首部对比)
- [3. 传输控制协议](#3-传输控制协议)
	- [3.1. TCP报文段的首部格式](#31-tcp报文段的首部格式)
		- [3.1.1. 序号、确认号、确认标志位ACK](#311-序号确认号确认标志位ack)
		- [3.1.2. 数据偏移](#312-数据偏移)
		- [3.1.3. 保留](#313-保留)
		- [3.1.4. 窗口](#314-窗口)
		- [3.1.5. 检验和](#315-检验和)
		- [3.1.6. 同步标志位SYN](#316-同步标志位syn)
		- [3.1.7. 终止标志位FIN](#317-终止标志位fin)
		- [3.1.8. 复位标志位RST](#318-复位标志位rst)
		- [3.1.9. 推送标志位PSH](#319-推送标志位psh)
		- [3.1.10. 紧急标志位URG、紧急指针](#3110-紧急标志位urg紧急指针)
		- [3.1.11. 选项（长度可变，最大40字节）](#3111-选项长度可变最大40字节)
		- [3.1.12. 填充](#3112-填充)
	- [3.2. TCP的运输层连接管理](#32-tcp的运输层连接管理)
		- [3.2.1. “三报文握手”建立连接](#321-三报文握手建立连接)
		- [3.2.2. “四报文挥手”释放连接](#322-四报文挥手释放连接)
	- [3.3. TCP的流量控制](#33-tcp的流量控制)
		- [3.3.1. 基本概念](#331-基本概念)
		- [3.3.2. 控制方法](#332-控制方法)
	- [3.4. TCP的拥塞控制](#34-tcp的拥塞控制)
		- [3.4.1. 基本概念](#341-基本概念)
		- [3.4.2. 基本方法](#342-基本方法)
			- [3.4.2.1. 对比流量控制](#3421-对比流量控制)
			- [3.4.2.2. 开环控制与闭环控制](#3422-开环控制与闭环控制)
			- [3.4.2.3. 衡量网络拥塞的指标](#3423-衡量网络拥塞的指标)
			- [3.4.2.4. 闭环拥塞控制算法](#3424-闭环拥塞控制算法)
			- [3.4.2.5. 代价](#3425-代价)
		- [3.4.3. TCP的四种拥塞控制方法](#343-tcp的四种拥塞控制方法)
			- [3.4.3.1. 慢开始算法和拥塞避免算法](#3431-慢开始算法和拥塞避免算法)
			- [3.4.3.2. 快重传算法和快恢复算法（改进TCP性能，1990年Reno版本）](#3432-快重传算法和快恢复算法改进tcp性能1990年reno版本)
			- [3.4.3.3. 四种控制方法拥塞窗口变化图](#3433-四种控制方法拥塞窗口变化图)
			- [3.4.3.4. TCP拥塞控制流程图](#3434-tcp拥塞控制流程图)
		- [3.4.4. TCP拥塞控制与网际层拥塞控制的关系](#344-tcp拥塞控制与网际层拥塞控制的关系)
	- [3.5. TCP可靠传输的实现](#35-tcp可靠传输的实现)
	- [3.6. TCP超时重传时间的选择](#36-tcp超时重传时间的选择)
	- [3.7. TCP的选择确认](#37-tcp的选择确认)
- [4. 题目](#4-题目)
	- [4.1. TCP序号、确认号](#41-tcp序号确认号)
		- [4.1.1. 【2009 38】](#411-2009-38)
		- [4.1.2. 【2013 39】](#412-2013-39)
		- [4.1.3. 【2011 40】](#413-2011-40)
	- [4.2. 建立TCP连接](#42-建立tcp连接)
		- [4.2.1. 【2011 39】](#421-2011-39)
		- [4.2.2. 【2019 39】](#422-2019-39)
	- [4.3. 释放TCP连接](#43-释放tcp连接)
		- [4.3.1. 【2020 39】](#431-2020-39)
	- [4.4. TCP流量控制](#44-tcp流量控制)
		- [4.4.1. 【2010 39】](#441-2010-39)
	- [4.5. TCP拥塞控制](#45-tcp拥塞控制)
		- [4.5.1. 【2009 39】](#451-2009-39)
		- [4.5.2. 【2014 38】](#452-2014-38)
		- [4.5.3. 【2015 39】](#453-2015-39)
		- [4.5.4. 【2017 39】](#454-2017-39)
		- [4.5.5. 【2019 38】](#455-2019-38)
		- [4.5.6. 【2020 38】](#456-2020-38)
	- [4.6. TCP超时重传的时间选择](#46-tcp超时重传的时间选择)

<!-- /TOC -->

## 1. 运输层概述

### 1.1. 进程间基于网络的通信

- 计算机网络体系结构中的**物理层、数据链路层和网络层**，它们共同解决了将主机通过异构网络互联起来所面临的问题，实现了**主机到主机的通信**。
- 计算机网络中实际进行**通信的真正实体，是位于通信两端主机中的进程**。
- 运输层的主要任务：为运行在不同主机上的应用进程提供直接的逻辑通信服务
- 运输层协议又称为端到端协议。

<img src="chapter-5.assets/image-20221114003725568.png" alt="image-20221114003725568" style="zoom:40%;" />

<img src="chapter-5.assets/image-20221114003808040.png" alt="image-20221114003808040" style="zoom:40%;" />

-   运输层向应用层实体屏蔽了下面网络核心的细节（例如网络拓扑、所采用的路由选择协议等），它使应用进程看见的就好像是在两个运输层实体之间有一条端到端的逻辑通信信道。
-   根据应用需求的不同，因特网的运输层为应用层提供了两种不同的运输层协议，即面向连接的TC和无连接的UDP，这两种协议就是本章要讨论的主要内容。

### 1.2. TCP/IP运输层中的两个重要协议

<img src="chapter-5.assets/image-20221114004204485.png" alt="image-20221114004204485" style="zoom:42%;" />

<img src="chapter-5.assets/image-20221114004310396.png" alt="image-20221114004310396" style="zoom:41%;" />

<img src="chapter-5.assets/image-20221114004337887.png" alt="image-20221114004337887" style="zoom:45%;" />

### 1.3. 运输层端口号

-   运行在计算机上的进程是使用进程标识符（Process Identification，PID）来标识的。
	-   不同操作系统（Windows、Linux、MacOS）又使用不同格式的进程标识符。
	-   为了使运行不同操作系统的计算机的应用进程之间能够基于网络进行通信，就必须使用统一的方法对TCP/IP体系的应用进程进行标识。

- TCP/IP体系结构的运输层使用**端口号**来**标识和区分应用层的不同应用进程**。
- 端口号的**长度为16比特，取值范围是0~65535**。

<img src="chapter-5.assets/image-20221114004834781.png" alt="image-20221114004834781" style="zoom:40%;" />

### 1.4. 发送方的复用和接收方的分用

<img src="chapter-5.assets/image-20221114005011042.png" alt="image-20221114005011042" style="zoom:43%;" />

#### 1.4.1. TCP/IP体系结构应用层常用协议所使用的运输层协议和熟知端口号

-   **OSPF报文并不使用运输层的UDP或TCP进行封装，而是直接使用网际层的IP进行封装。**

<img src="chapter-5.assets/image-20221114005445042.png" alt="image-20221114005445042" style="zoom:45%;" />

### 1.5. 运输层端口号应用举例

<img src="chapter-5.assets/image-20221114010231968.png" alt="image-20221114010231968" style="zoom:25%;" />

<img src="chapter-5.assets/image-20221114010320709.png" alt="image-20221114010320709" style="zoom:25%;" />

## 2. UDP和TCP的对比

<img src="chapter-5.assets/image-20221114104159220.png" alt="image-20221114104159220" style="zoom:50%;" />

|                         UDP                          |                        TCP                        |
| :--------------------------------------------------: | :-----------------------------------------------: |
|                        无连接                        |                     面向连接                      |
| 支持“一对一”、“一对多”、“多对一”和“多对多”交互通信。 | 每一条TCP连接只能有两个端点EP，只能是一对一通信。 |
|                     面向应用报文                     |                    面向字节流                     |
| 尽最大努力交付，即不可靠；不使用流量控制和拥塞控制。 |        可靠传输，使用流量控制和拥塞控制。         |
|                首部开销小，仅8字节。                 |           首部最小20字节，最大60字节。            |

### 2.1. 无连接的UDP和面向连接的TCP

-   这里的“连接”指的是逻辑链接关系，不是物理连接。

<img src="chapter-5.assets/image-20221114104324785.png" alt="image-20221114104324785" style="zoom:40%;" />

### 2.2. 对单播、多播和广播的支持情况

<img src="chapter-5.assets/image-20221114105144300.png" alt="image-20221114105144300" style="zoom: 20%;" />

### 2.3. 对应用层报文的处理

<img src="chapter-5.assets/image-20221114105443572.png" alt="image-20221114105443572" style="zoom:38%;" />

### 2.4. 对数据传输可靠性的支持情况

<img src="chapter-5.assets/image-20221114105626310.png" alt="image-20221114105626310" style="zoom:38%;" />

### 2.5. 首部对比

<img src="chapter-5.assets/image-20221114105731057.png" alt="image-20221114105731057" style="zoom:38%;" />

## 3. 传输控制协议

### 3.1. TCP报文段的首部格式

<img src="chapter-5.assets/image-20221114114418410.png" alt="image-20221114114418410" style="zoom: 60%;" />

#### 3.1.1. 序号、确认号、确认标志位ACK

<img src="chapter-5.assets/image-20221114114907479.png" alt="image-20221114114907479" style="zoom: 37%;" />

-   举例

<img src="chapter-5.assets/image-20221114114942945.png" alt="image-20221114114942945" style="zoom: 33%;" />

-   确认号应该是**已接收且按序到达**的最后一次的下一个数据载荷的第一个字节序号。（连续发送中间有丢失情况）

#### 3.1.2. 数据偏移

<img src="chapter-5.assets/image-20221114115336665.png" alt="image-20221114115336665" style="zoom:38%;" />

#### 3.1.3. 保留

- 占6比特
- 保留为今后使用
- 目前应置为0

#### 3.1.4. 窗口

-   取值范围$[0,2^{16}-1]$

<img src="chapter-5.assets/image-20221114115505439.png" alt="image-20221114115505439" style="zoom: 50%;" />

#### 3.1.5. 检验和

- 占16比特
- 用来检查整个TCP报文段在传输过程中是否出现了误码。

-   与UDP类似，在计算检验和时，要在TCP报文段前面加上12字节的伪首部

<img src="chapter-5.assets/image-20221114142127131.png" alt="image-20221114142127131" style="zoom:40%;" />

-   对比UDP

<img src="chapter-5.assets/image-20221114142210964.png" alt="image-20221114142210964" style="zoom:40%;" />

#### 3.1.6. 同步标志位SYN

<img src="chapter-5.assets/image-20221114142451378.png" alt="image-20221114142451378" style="zoom:50%;" />

#### 3.1.7. 终止标志位FIN

<img src="chapter-5.assets/image-20221114142512402.png" alt="image-20221114142512402" style="zoom:50%;" />

#### 3.1.8. 复位标志位RST

<img src="chapter-5.assets/image-20221114142829298.png" alt="image-20221114142829298" style="zoom:50%;" />

#### 3.1.9. 推送标志位PSH

<img src="chapter-5.assets/image-20221114142853282.png" alt="image-20221114142853282" style="zoom:40%;" />

#### 3.1.10. 紧急标志位URG、紧急指针

<img src="chapter-5.assets/image-20221114142927612.png" alt="image-20221114142927612" style="zoom:40%;" />

#### 3.1.11. 选项（长度可变，最大40字节）

<img src="chapter-5.assets/image-20221114142956734.png" alt="image-20221114142956734" style="zoom:45%;" />

#### 3.1.12. 填充

<img src="chapter-5.assets/image-20221114143103889.png" alt="image-20221114143103889" style="zoom:37%;" />

### 3.2. TCP的运输层连接管理

<img src="chapter-5.assets/image-20221114143403082.png" alt="image-20221114143403082" style="zoom:45%;" />

#### 3.2.1. “三报文握手”建立连接

- 三报文握手”建立TCP连接的目的
	- 使TCP双方能够确知对方的存在。
	- 使TCP双方能够协商一些参数
		- 例如最大报文段长度、最大窗口大小、时间戳选项等。
    - 使TCP双方能够对运输实体资源进行分配和初始化。
	    - 运输实体资源包括缓存大小、各状态变量、连接表中的项目等。

<img src="chapter-5.assets/image-20221114144028999.png" alt="image-20221114144028999" style="zoom: 33%;" />

-   “三报文”而不是“两报文”

<img src="chapter-5.assets/image-20221114150308410.png" alt="image-20221114150308410" style="zoom:42%;" />

#### 3.2.2. “四报文挥手”释放连接

<img src="chapter-5.assets/image-20221114151050518.png" alt="image-20221114151050518" style="zoom:50%;" />

-   等待2MSL原因

<img src="chapter-5.assets/image-20221114151247726.png" alt="image-20221114151247726" style="zoom:37%;" />

-   TCP保活计时器的作用

<img src="chapter-5.assets/image-20221114152232759.png" alt="image-20221114152232759" style="zoom:38%;" />

### 3.3. TCP的流量控制

#### 3.3.1. 基本概念

<img src="chapter-5.assets/image-20221114152616538.png" alt="image-20221114152616538" style="zoom: 40%;" />

#### 3.3.2. 控制方法

<img src="chapter-5.assets/image-20221114154516440.png" alt="image-20221114154516440" style="zoom: 45%;" />

<img src="chapter-5.assets/image-20221114155121279.png" alt="image-20221114155121279" style="zoom:41%;" />

<img src="chapter-5.assets/image-20221114154814576.png" alt="image-20221114154814576" style="zoom:41%;" />

<img src="chapter-5.assets/image-20221114154855461.png" alt="image-20221114154855461" style="zoom:44%;" />

- A发送的零窗口探测报文段到达B时，如果B此时的接收窗口值仍然为0，那么B根本就无法接受该报文段，又怎么会针对该报文段给A发回确认呢？
	- 实际上TCP规定：即使接收窗口值为0，也必须接受零窗口探测报文段、确认报文段以及携带有紧急数据的报文段。
- 如果零窗口探测报文段丢失了，还会打破死锁的局面吗？
	- 回答是肯定的。因为零窗口探测报文段也有重传计时器， 当重传计时器超时后，零窗口探测报文段会被重传。

### 3.4. TCP的拥塞控制

#### 3.4.1. 基本概念

- 拥塞（congestion）
	- 在某段时间，若**对网络中某一资源的需求超过了该资源所能提供的可用部分，网络性能就要变坏**的情况。
- 计算机网络中的链路容量（带宽）、交换节点中的缓存和处理机等都是网络的资源。
- 若出现拥塞而不进行控制，整个网络的吞吐量将随输入负荷的增大而下降。

<img src="chapter-5.assets/image-20221114211227567.png" alt="image-20221114211227567" style="zoom:50%;" />

#### 3.4.2. 基本方法

##### 3.4.2.1. 对比流量控制

<img src="chapter-5.assets/image-20221114211442594.png" alt="image-20221114211442594" style="zoom:40%;" />

##### 3.4.2.2. 开环控制与闭环控制

<img src="chapter-5.assets/image-20221114211530461.png" alt="image-20221114211530461" style="zoom:40%;" />

##### 3.4.2.3. 衡量网络拥塞的指标

<img src="chapter-5.assets/image-20221114211617835.png" alt="image-20221114211617835" style="zoom:40%;" />

##### 3.4.2.4. 闭环拥塞控制算法

<img src="chapter-5.assets/image-20221114211853291.png" alt="image-20221114211853291" style="zoom:40%;" />

##### 3.4.2.5. 代价

<img src="chapter-5.assets/image-20221114212049403.png" alt="image-20221114212049403" style="zoom:55%;" />

#### 3.4.3. TCP的四种拥塞控制方法

<img src="chapter-5.assets/image-20221114212553562.png" alt="image-20221114212553562" style="zoom:40%;" />

##### 3.4.3.1. 慢开始算法和拥塞避免算法

- “慢开始”是指一开始向网络注入的报文段少，而并不是指拥塞窗口cwnd的值增长速度慢。
- “拥塞避免”也并非指完全能够避免拥塞，而是指在拥塞避免阶段将cwnd值控制为按线性规律增长，使网络比较不容易出现拥塞。

<img src="chapter-5.assets/image-20221114212900986.png" alt="image-20221114212900986" style="zoom:40%;" />

<img src="chapter-5.assets/image-20221114214138924.png" alt="image-20221114214138924" style="zoom:25%;" />

<img src="chapter-5.assets/image-20221114214240190.png" alt="image-20221114214240190" style="zoom:43%;" />

##### 3.4.3.2. 快重传算法和快恢复算法（改进TCP性能，1990年Reno版本）

-   改进：IP数据包误码被丢弃，导致重传计时器超时，使发送方误认为网络出现了拥塞，重新执行慢开始算法，降低了传输效率。
-   “快重传”是指使发送方尽快（尽早）进行重传，而不是等重传计时器超时再重传。
	-   这就要求接收方不要等待自己发送数据时才进行捎带确认，而是要**立即发送确认，即使收到了失序的报文段也要立即发出对已收到的报文段的重复确认**。
	-   发送方一旦收到**3个连续的重复确认，就将相应的报文段立即重传**，而不是等该报文段的重传计时器超时再重传。
-   快重传：收到不是按序到达的报文段就发送上一个报文段的重复确认。
	-   采用快重传算法可以让发送方尽早知道发生了个别TCP报文段的丢失。
	<img src="chapter-5.assets/image-20221114215128995.png" alt="image-20221114215128995" style="zoom:40%;" />

-   快恢复：发送方一旦收到3个重复确认，就知道现在只是丢失了个别的报文段，于是不启动慢开始算法，而是执行快恢复算法。
	-   发送方将慢开始门限ssthresh的值和拥塞窗口cwnd的值都调整为当前cwnd值的一半，并开始执行拥塞避免算法。
	-   也有的快恢复实现是把快恢复开始时的cwnd值再增大一些，即cwnd=新ssthresh+3。
		-   既然发送方收到了3个重复的确认，就表明有3个数据报文段已经离开了网络。
		-   这3个报文段不再消耗网络资源而是停留在接收方的接收缓存中。
		-   可见现在网络中不是堆积了报文段而是减少了3个报文段，因此可以适当把cwnd值增大一些。

##### 3.4.3.3. 四种控制方法拥塞窗口变化图

<img src="chapter-5.assets/image-20221114215728139.png" alt="image-20221114215728139" style="zoom:38%;" />

##### 3.4.3.4. TCP拥塞控制流程图

<img src="chapter-5.assets/image-20221114220010516.png" alt="image-20221114220010516" style="zoom:45%;" />

#### 3.4.4. TCP拥塞控制与网际层拥塞控制的关系

<img src="chapter-5.assets/image-20221114224012493.png" alt="image-20221114224012493" style="zoom:38%;" />

<img src="chapter-5.assets/image-20221114224049355.png" alt="image-20221114224049355" style="zoom:43%;" />

<img src="chapter-5.assets/image-20221114224226737.png" alt="image-20221114224226737" style="zoom:43%;" />

### 3.5. TCP可靠传输的实现

<img src="chapter-5.assets/image-20221114225719951.png" alt="image-20221114225719951" style="zoom:38%;" />

<img src="chapter-5.assets/image-20221114225921413.png" alt="image-20221114225921413" style="zoom:41%;" />

<img src="chapter-5.assets/image-20221114230140354.png" alt="image-20221114230140354" style="zoom:40%;" />

<img src="chapter-5.assets/image-20221114230244906.png" alt="image-20221114230244906" style="zoom:36%;" />

<img src="chapter-5.assets/image-20221114230523704.png" alt="image-20221114230523704" style="zoom:40%;" />

<img src="chapter-5.assets/image-20221114230641718.png" alt="image-20221114230641718" style="zoom:38%;" />

<img src="chapter-5.assets/image-20221114230734385.png" alt="image-20221114230734385" style="zoom:38%;" />

<img src="chapter-5.assets/image-20221114231009270.png" alt="image-20221114231009270" style="zoom:41%;" />

### 3.6. TCP超时重传时间的选择

<img src="chapter-5.assets/image-20221114232030171.png" alt="image-20221114232030171" style="zoom:48%;" />

-   RTTS计算

<img src="chapter-5.assets/image-20221114232119341.png" alt="image-20221114232119341" style="zoom:40%;" />

<img src="chapter-5.assets/image-20221114232200465.png" alt="image-20221114232200465" style="zoom:38%;" />

<img src="chapter-5.assets/image-20221114232407267.png" alt="image-20221114232407267" style="zoom:40%;" />

-   总结

<img src="chapter-5.assets/image-20221114232515262.png" alt="image-20221114232515262" style="zoom:41%;" />

### 3.7. TCP的选择确认

<img src="chapter-5.assets/image-20221114233038961.png" alt="image-20221114233038961" style="zoom:40%;" />

<img src="chapter-5.assets/image-20221114233117108.png" alt="image-20221114233117108" style="zoom:44%;" />

## 4. 题目

### 4.1. TCP序号、确认号

#### 4.1.1. 【2009 38】

<img src="chapter-5.assets/image-20221114115112557.png" alt="image-20221114115112557" style="zoom: 39%;" />

#### 4.1.2. 【2013 39】

<img src="chapter-5.assets/image-20221114115150365.png" alt="image-20221114115150365" style="zoom:39%;" />

#### 4.1.3. 【2011 40】

<img src="chapter-5.assets/image-20221114115229740.png" alt="image-20221114115229740" style="zoom:38%;" />

### 4.2. 建立TCP连接 

#### 4.2.1. 【2011 39】

<img src="chapter-5.assets/image-20221114145857728.png" alt="image-20221114145857728" style="zoom:36%;" />

#### 4.2.2. 【2019 39】

<img src="chapter-5.assets/image-20221114150059730.png" alt="image-20221114150059730" style="zoom:36%;" />

### 4.3. 释放TCP连接

#### 4.3.1. 【2020 39】

<img src="chapter-5.assets/image-20221114152012332.png" alt="image-20221114152012332" style="zoom:39%;" />

### 4.4. TCP流量控制

#### 4.4.1. 【2010 39】

<img src="chapter-5.assets/image-20221114154136756.png" alt="image-20221114154136756" style="zoom:40%;" />

### 4.5. TCP拥塞控制

#### 4.5.1. 【2009 39】

<img src="chapter-5.assets/image-20221114221246421.png" alt="image-20221114221246421" style="zoom:38%;" />

#### 4.5.2. 【2014 38】

<img src="chapter-5.assets/image-20221114222454522.png" alt="image-20221114222454522" style="zoom:43%;" />

#### 4.5.3. 【2015 39】

<img src="chapter-5.assets/image-20221114222836847.png" alt="image-20221114222836847" style="zoom:41%;" />

#### 4.5.4. 【2017 39】

<img src="chapter-5.assets/image-20221114223252853.png" alt="image-20221114223252853" style="zoom:38%;" />

#### 4.5.5. 【2019 38】

<img src="chapter-5.assets/image-20221114223644312.png" alt="image-20221114223644312" style="zoom:38%;" />

#### 4.5.6. 【2020 38】

<img src="chapter-5.assets/image-20221114223600494.png" alt="image-20221114223600494" style="zoom:40%;" />

### 4.6. TCP超时重传的时间选择

<img src="chapter-5.assets/image-20221114232814167.png" alt="image-20221114232814167" style="zoom:50%;" />